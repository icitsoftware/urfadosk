<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Üye Kayıt Formu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #signature {
            border: 1px solid #ccc;
            width: 300px;
            height: 100px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
        <h2 class="text-center">URFADOSK Üye Kayıt Formu</h2>
        </div>
        <div class="card-body">
        <form id="form">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="tc" class="form-label">T.C. Kimlik No*</label>
                    <input type="text" class="form-control" id="tc" name="tc" value="4324324" required >
                </div>
                <div class="col-md-3">
                    <label for="name" class="form-label">Adı Soyadı*</label>
                    <input type="text" class="form-control" id="name" name="name" value="John Doe" required placeholder="Adı Soyadı">
                </div>
                <br>
                <div class="col-md-3">
                    <label for="fatherName" class="form-label">Baba Adı</label>
                    <input type="text" class="form-control" id="fatherName" name="fatherName" value="Joe Doe" placeholder="Baba Adı">
                </div>
                <br>
                <div class="col-md-3">
                    <label for="motherName" class="form-label">Ana Adı</label>
                    <input type="text" class="form-control" id="motherName" name="motherName" value="Jane Doe" placeholder="Ana Adı">
            </div>
        </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="birthDate" class="form-label">Doğum Tarihi*</label>
                    <input type="date" class="form-control" id="birthDate" name="birthDate" value="1990-01-01" required>
                </div>
                <div class="col-md-3">
                    <label for="nationality" class="form-label">Uyruğu*</label>
                    <input type="text" class="form-control" id="nationality" name="nationality" value="TC" required>
                </div>
                <div class="col-md-3">
                    <label for="serialNo" class="form-label">Seri No</label>
                    <input type="text" class="form-control" id="serialNo" name="serialNo" value="12312312">
                </div>
                <div class="col-md-3">
                    <label for="bloodType" class="form-label">Kan Grubu*</label>
                    <select class="form-select" id="bloodType" name="bloodType">
                        <option value="0 Rh(+)" selected>0 Rh(+)</option>
                        <option value="0 Rh(-)">0 Rh(-)</option>
                        <option value="A Rh(+)">A Rh(+)</option>
                        <option value="A Rh(-)">A Rh(-)</option>
                        <option value="B Rh(+)">B Rh(+)</option>
                        <option value="B Rh(-)">B Rh(-)</option>
                        <option value="AB Rh(+)">AB Rh(+)</option>
                        <option value="AB Rh(-)">AB Rh(-)</option>
                    </select>
                </div>                
            </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="email" class="form-label">E-posta</label>
                    <input type="email" class="form-control" id="email" name="email" value="john.doe@example.com">
                </div>
                <div class="col-md-3">
                    <label for="phone" class="form-label">Cep Telefonu*</label>
                    <input type="tel" class="form-control" id="phone" name="phone" value="+905551234567" required>
                </div>
                <div class="col-md-3">
                    <label for="educationLevel" class="form-label">Tahsili</label>
                    <select class="form-select" id="educationLevel" name="educationLevel">
                        <option value="İlkokul">İlkokul</option>
                        <option value="Ortaokul">Ortaokul</option>
                        <option value="Lise">Lise</option>
                        <option value="Ön Lisans">Ön Lisans</option>
                        <option value="Lisans" selected>Lisans</option>
                        <option value="Yüksek Lisans">Yüksek Lisans</option>
                        <option value="Doktora">Doktora</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="job" class="form-label">Mesleği</label>
                    <input type="text" class="form-control" id="job" name="job" value="Mühendis">
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="homeAddress" class="form-label">Ev Adresi*</label>
                    <input type="text" class="form-control" id="homeAddress" name="homeAddress" value="Bağdat Cad. No:12, Kadıköy, İstanbul" required>
                </div>
                <div class="col-md-3">
                    <label for="homePhone" class="form-label">Ev Telefonu</label>
                    <input type="text" class="form-control" id="homePhone" name="homePhone" value="0414345345345">
                </div>
                <div class="col-md-3">
                    <label for="workAddress" class="form-label">İş Adresi</label>
                    <input type="text" class="form-control" id="workAddress" name="workAddress" value="Bağdat Cad. No:12, Şişli, İstanbul">
                </div>
                <div class="col-md-3">
                    <label for="workPhone" class="form-label">İş Telefonu</label>
                    <input type="text" class="form-control" id="workPhone" name="workPhone" value="021612312323">
                </div>
                
            </div>
            <h3>Acil Durumda Haber Verilecek Kişi</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="emergencyName" class="form-label">Adı Soyadı*</label>
                    <input type="text" class="form-control" id="emergencyName" name="emergencyName" value="Jane Doe" required>
                </div>
                <div class="col-md-6">
                    <label for="emergencyRelation" class="form-label">Yakınlığı</label>
                    <input type="text" class="form-control" id="emergencyRelation" name="emergencyRelation" value="Annesi">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="emergencyAddress" class="form-label">Adresi</label>
                    <input type="text" class="form-control" id="emergencyAddress" name="emergencyAddress" value="Bağdat Cad. No:14, Kadıköy, İstanbul">
                </div>
                <div class="col-md-6">
                    <label for="emergencyPhone" class="form-label">Telefonu*</label>
                    <input type="tel" class="form-control" id="emergencyPhone" name="emergencyPhone" value="+905551234568" required>
                </div>
            </div>
        
            <h3>İmza:</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <canvas id="signature" class="border border-secondary"></canvas><br>
                    <button type="button" class="btn btn-secondary" id="clearSignature">İmza Sil</button><br><br>
                </div>
                <div class="col-md-6">
                    <button type="submit" class="btn btn-primary">PDF'e Bilgileri Yerleştir ve Görüntüle</button>
                </div>
            </div>
        </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        function convertToAscii(text) {
                const asciiMap = {
                    'ç': 'c', 'ğ': 'g', 'ı': 'i', 'İ': 'I', 'ö': 'o', 'ş': 's', 'ü': 'u',
                    'Ç': 'C', 'Ğ': 'G', 'Ö': 'O', 'Ş': 'S', 'Ü': 'U'
                };

                return text.split('').map(char => asciiMap[char] || char).join('');
            }
            
        const canvas = document.getElementById('signature');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function resizeCanvas() {
            const savedData = canvas.toDataURL();
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = 300 * ratio;
            canvas.height = 100 * ratio;
            ctx.scale(ratio, ratio);
            ctx.lineWidth = 2;

            const img = new Image();
            img.src = savedData;
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
            };
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getTouchPos(canvasDom, touchEvent) {
            const rect = canvasDom.getBoundingClientRect();
            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            };
        }

        function getMousePos(canvasDom, mouseEvent) {
            const rect = canvasDom.getBoundingClientRect();
            return {
                x: mouseEvent.clientX - rect.left,
                y: mouseEvent.clientY - rect.top
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            const pos = getMousePos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (drawing) {
                const pos = getMousePos(canvas, e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => {
            drawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            drawing = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            drawing = true;
            const pos = getTouchPos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (drawing) {
                const pos = getTouchPos(canvas, e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('touchend', () => {
            drawing = false;
        });

        document.getElementById('clearSignature').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        document.getElementById('form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const tc = convertToAscii(document.getElementById('tc').value);
            const name = convertToAscii(document.getElementById('name').value);
            const fatherName = convertToAscii(document.getElementById('fatherName').value);
            const motherName = convertToAscii(document.getElementById('motherName').value);
            const birthDate = convertToAscii(document.getElementById('birthDate').value);
            const nationality = convertToAscii(document.getElementById('nationality').value);
            const serialNo = convertToAscii(document.getElementById('serialNo').value);
            const bloodType = convertToAscii(document.getElementById('bloodType').value);
            const email = convertToAscii(document.getElementById('email').value);
            const phone = convertToAscii(document.getElementById('phone').value);
            const educationLevel = convertToAscii(document.getElementById('educationLevel').value);
            const job = convertToAscii(document.getElementById('job').value);
            const homeAddress = convertToAscii(document.getElementById('homeAddress').value);
            const homePhone = convertToAscii(document.getElementById('homePhone').value);
            const workAddress = convertToAscii(document.getElementById('workAddress').value);
            const workPhone = convertToAscii(document.getElementById('workPhone').value);
            const emergencyName = convertToAscii(document.getElementById('emergencyName').value);
            const emergencyRelation = convertToAscii(document.getElementById('emergencyRelation').value);
            const emergencyAddress = convertToAscii(document.getElementById('emergencyAddress').value);
            const emergencyPhone = convertToAscii(document.getElementById('emergencyPhone').value);

            const signatureDataUrl = canvas.toDataURL('image/png');

            const existingPdfBytes = await fetch("Urfadosk_2024_Uye_Kayit_Belgesi.pdf").then(res => res.arrayBuffer());

            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).padStart(2, '0').slice(-1);

            firstPage.drawText(tc, { x: 215, y: 674, size: 10 });
            firstPage.drawText(name, { x: 215, y: 662, size: 10 });
            firstPage.drawText(fatherName, { x: 215, y: 650, size: 10 });
            firstPage.drawText(motherName, { x: 215, y: 637, size: 10 });
            firstPage.drawText(birthDate, { x: 215, y: 624, size: 10 });
            firstPage.drawText(nationality, { x: 215, y: 612, size: 10 });
            firstPage.drawText(serialNo, { x: 215, y: 599, size: 10 });
            firstPage.drawText(bloodType, { x: 215, y: 587, size: 10 });
            firstPage.drawText(email, { x: 215, y: 575, size: 10 });
            firstPage.drawText(phone, { x: 215, y: 562, size: 10 });
            firstPage.drawText(educationLevel, { x: 215, y: 500, size: 10 });
            firstPage.drawText(job, { x: 410, y: 500, size: 10 });
            firstPage.drawText(homeAddress, { x: 215, y: 487, size: 10 });
            firstPage.drawText(homePhone, { x: 215, y: 475, size: 10 });
            firstPage.drawText(workAddress, { x: 215, y: 462, size: 10 });
            firstPage.drawText(workPhone, { x: 215, y: 450, size: 10 });
            firstPage.drawText(emergencyName, { x: 215, y: 398, size: 10 });
            firstPage.drawText(emergencyRelation, { x: 215, y: 384, size: 10 });
            firstPage.drawText(emergencyAddress, { x: 215, y: 372, size: 10 });
            firstPage.drawText(emergencyPhone, { x: 215, y: 359, size: 10 });
            firstPage.drawText(day, { x: 350, y: 304, size: 10 });
            firstPage.drawText(month, { x: 366, y: 304, size: 10 });
            firstPage.drawText(year, { x: 399, y: 304, size: 10});
            firstPage.drawText(name, { x: 440, y: 265, size: 10 });

            const signatureImage = await pdfDoc.embedPng(signatureDataUrl);
            const signatureDims = signatureImage.scale(0.2);
            firstPage.drawImage(signatureImage, {
                x: 430,
                y: 230,
                width: signatureDims.width,
                height: signatureDims.height,
            });

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            let newWindow = null;

            // Tarayıcı kontrolü
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isMiBrowser = /MiuiBrowser/i.test(navigator.userAgent);

            if (isSafari || isMiBrowser) {
                // Safari veya Mi tarayıcı ise PDF'i indirmeyi öner
                const link = document.createElement('a');
                link.href = url;
                link.download = 'document.pdf'; // İndirilecek PDF dosyasının adı
                link.click();
                alert('Tarayıcıda PDF açma desteği kısıtlı. Dosya indiriliyor.');
            } else {
                // Diğer tarayıcılar için yeni sekme açmayı dene
                newWindow = window.open(url, '_blank');
                if (newWindow === null) {
                    alert("Pop-up engellendi. Lütfen tarayıcı ayarlarından pop-up izni verin.");
                } else {
                    newWindow.focus();
                }
            }

        });
    </script>
</body>
</html>
