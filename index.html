<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Üye Kayıt Formu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        #signature {
            border: 1px solid #ccc;
            width: 250px;
            height: 100px;
        }
        body {
            background-image: url('18012022221156-90314-65935.png');            
            background-repeat: repeat; 
            background-size: 250px 250px;
            background-color: rgba(0,0, 0, 0.03)
        }
        .card-body {
            background-color: rgba(0,0, 0, 0.03)

        }

    </style>
</head>
<body>
    <div class="container mt-3">
        <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
        <h2 class="text-center">URFADOSK Üye Kayıt Formu - <span id="currentDate"></span></h2>
    </div>
    <p class="card-header text-muted text-center" style="background-color: #ffeb3b; color: #333; border: 2px solid #ffa000; padding: 1rem; border-radius: 8px; font-weight: bold; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);">
        <i class="fas fa-exclamation-circle" style="color: #ff5722; margin-right: 0.5rem;"></i>
        Formu doldurup PDF çıktısını, 3 vesikalık fotoğraf, nüfus cüzdanı fotokopisi ve aidat makbuzuyla birlikte kulübe teslim edin. Aidat IBAN bilgisi PDF’de.
    </p>
    
    <div class="card-body">
        <form id="form">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="tc" class="form-label">T.C. Kimlik No*</label>
                    <input type="text" class="form-control" id="tc" name="tc" required placeholder="T.C. Kimlik Numaranız">
                </div>
                <div class="col-md-3">
                    <label for="name" class="form-label">Adı Soyadı*</label>
                    <input type="text" class="form-control" id="name" name="name" required placeholder="Adı Soyadı">
                </div>
                <br>
                <div class="col-md-3">
                    <label for="fatherName" class="form-label">Baba Adı*</label>
                    <input type="text" class="form-control" id="fatherName" name="fatherName" placeholder="Baba Adı" required>
                </div>
                <br>
                <div class="col-md-3">
                    <label for="motherName" class="form-label">Ana Adı*</label>
                    <input type="text" class="form-control" id="motherName" name="motherName" placeholder="Ana Adı" required>
            </div>
        </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="birthDate" class="form-label">Doğum Tarihi*</label>
                    <input type="date" class="form-control" id="birthDate" name="birthDate" required>
                </div>
                <div class="col-md-3">
                    <label for="nationality" class="form-label">Uyruğu*</label>
                    <input type="text" class="form-control" id="nationality" name="nationality" required placeholder="Örn: TC">
                </div>
                <div class="col-md-3">
                    <label for="serialNo" class="form-label">Seri No</label>
                    <input type="text" class="form-control" id="serialNo" name="serialNo" placeholder="Kimlik Seri No" >
                </div>
                <div class="col-md-3">
                    <label for="bloodType" class="form-label">Kan Grubu*</label>
                    <select class="form-select" id="bloodType" name="bloodType">
                        <option value="0 Rh(+)" selected>0 Rh(+)</option>
                        <option value="0 Rh(-)">0 Rh(-)</option>
                        <option value="A Rh(+)">A Rh(+)</option>
                        <option value="A Rh(-)">A Rh(-)</option>
                        <option value="B Rh(+)">B Rh(+)</option>
                        <option value="B Rh(-)">B Rh(-)</option>
                        <option value="AB Rh(+)">AB Rh(+)</option>
                        <option value="AB Rh(-)">AB Rh(-)</option>
                    </select>
                </div>                
            </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="email" class="form-label">E-posta*</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="Geçerli bir e-posta adresi giriniz" required>
                </div>
                <div class="col-md-3">
                    <label for="phone" class="form-label">Cep Telefonu*</label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="+90" required>
                </div>
                <div class="col-md-3">
                    <label for="educationLevel" class="form-label">Tahsili</label>
                    <select class="form-select" id="educationLevel" name="educationLevel">
                        <option value="İlkokul">İlkokul</option>
                        <option value="Ortaokul">Ortaokul</option>
                        <option value="Lise">Lise</option>
                        <option value="Ön Lisans">Ön Lisans</option>
                        <option value="Lisans" selected>Lisans</option>
                        <option value="Yüksek Lisans">Yüksek Lisans</option>
                        <option value="Doktora">Doktora</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="job" class="form-label">Mesleği</label>
                    <input type="text" class="form-control" id="job" name="job" placeholder="Örn: Memur">
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="homeAddress" class="form-label">Ev Adresi*</label>
                    <input type="text" class="form-control" id="homeAddress" name="homeAddress" placeholder="İkamet adresinizi giriniz" required>
                </div>
                <div class="col-md-3">
                    <label for="homePhone" class="form-label">Ev Telefonu</label>
                    <input type="text" class="form-control" id="homePhone" name="homePhone" placeholder="Zorunlu değil">
                </div>
                <div class="col-md-3">
                    <label for="workAddress" class="form-label">İş Adresi</label>
                    <input type="text" class="form-control" id="workAddress" name="workAddress" placeholder="Zorunlu değil">
                </div>
                <div class="col-md-3">
                    <label for="workPhone" class="form-label">İş Telefonu</label>
                    <input type="text" class="form-control" id="workPhone" name="workPhone" placeholder="Zorunlu değil">
                </div>
                
            </div>
            <h3>Acil Durumda Haber Verilecek Kişi</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="emergencyName" class="form-label">Adı Soyadı*</label>
                    <input type="text" class="form-control" id="emergencyName" name="emergencyName" required placeholder="Yakının adı soyadı">
                </div>
                <div class="col-md-6">
                    <label for="emergencyRelation" class="form-label">Yakınlığı</label>
                    <input type="text" class="form-control" id="emergencyRelation" name="emergencyRelation" placeholder="Örn: Kardeşi">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="emergencyAddress" class="form-label">Adresi*</label>
                    <input type="text" class="form-control" id="emergencyAddress" name="emergencyAddress" placeholder="Yakının adres bilgisi">
                </div>
                <div class="col-md-6">
                    <label for="emergencyPhone" class="form-label">Telefonu*</label>
                    <input type="tel" class="form-control" id="emergencyPhone" name="emergencyPhone" placeholder="Yakının telefon numarası" required>
                </div>
            </div>
            <div class="row mb-3 g-3">
                
                <div class="col-md-6 d-flex justify-content-center align-items-center">
                    <h3>İmza: </h3>
                    <canvas id="signature" class="border border-secondary"></canvas><br>
                    <button type="button" class="btn " id="clearSignature" title="İmza Sil">
                        <img src="delete-close-svgrepo-com.svg" alt="İmza Sil" style="width: 20px; height: 20px;">
                      </button>
                    
                </div>
                <div class="col-md-6 d-flex justify-content-center align-items-end ">
                    <button type="submit" class="btn btn-primary">PDF'e Bilgileri Yerleştir ve Görüntüle</button>
                </div>
            </div>
        </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        function convertToAscii(text) {
                const asciiMap = {
                    'ç': 'c', 'ğ': 'g', 'ı': 'i', 'İ': 'I', 'ö': 'o', 'ş': 's', 'ü': 'u',
                    'Ç': 'C', 'Ğ': 'G', 'Ö': 'O', 'Ş': 'S', 'Ü': 'U'
                };

                return text.split('').map(char => asciiMap[char] || char).join('');
            }
            
        const canvas = document.getElementById('signature');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function resizeCanvas() {
            const savedData = canvas.toDataURL();
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = 250 * ratio;
            canvas.height = 100 * ratio;
            ctx.scale(ratio, ratio);
            ctx.lineWidth = 2;

            const img = new Image();
            img.src = savedData;
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
            };
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function formatDateToDDMMYYYY(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getTouchPos(canvasDom, touchEvent) {
            const rect = canvasDom.getBoundingClientRect();
            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            };
        }

        function getMousePos(canvasDom, mouseEvent) {
            const rect = canvasDom.getBoundingClientRect();
            return {
                x: mouseEvent.clientX - rect.left,
                y: mouseEvent.clientY - rect.top
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            const pos = getMousePos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (drawing) {
                const pos = getMousePos(canvas, e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => {
            drawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            drawing = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            drawing = true;
            const pos = getTouchPos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (drawing) {
                const pos = getTouchPos(canvas, e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        canvas.addEventListener('touchend', () => {
            drawing = false;
        });

        document.getElementById('clearSignature').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        document.getElementById("currentDate").innerText = new Date().toLocaleDateString('tr-TR');

        document.getElementById('form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const tc = convertToAscii(document.getElementById('tc').value);
            const name = convertToAscii(document.getElementById('name').value);
            const fatherName = convertToAscii(document.getElementById('fatherName').value);
            const motherName = convertToAscii(document.getElementById('motherName').value);
            const birthDate = convertToAscii(document.getElementById('birthDate').value);
            const formattedBirthDate = formatDateToDDMMYYYY(birthDate);
            const nationality = convertToAscii(document.getElementById('nationality').value);
            const serialNo = convertToAscii(document.getElementById('serialNo').value);
            const bloodType = convertToAscii(document.getElementById('bloodType').value);
            const email = convertToAscii(document.getElementById('email').value);
            const phone = convertToAscii(document.getElementById('phone').value);
            const educationLevel = convertToAscii(document.getElementById('educationLevel').value);
            const job = convertToAscii(document.getElementById('job').value);
            const homeAddress = convertToAscii(document.getElementById('homeAddress').value);
            const homePhone = convertToAscii(document.getElementById('homePhone').value);
            const workAddress = convertToAscii(document.getElementById('workAddress').value);
            const workPhone = convertToAscii(document.getElementById('workPhone').value);
            const emergencyName = convertToAscii(document.getElementById('emergencyName').value);
            const emergencyRelation = convertToAscii(document.getElementById('emergencyRelation').value);
            const emergencyAddress = convertToAscii(document.getElementById('emergencyAddress').value);
            const emergencyPhone = convertToAscii(document.getElementById('emergencyPhone').value);

            const signatureDataUrl = canvas.toDataURL('image/png');

            const existingPdfBytes = await fetch("Urfadosk_2024_Uye_Kayit_Belgesi.pdf").then(res => res.arrayBuffer());

            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).padStart(2, '0').slice(-1);

            firstPage.drawText(tc, { x: 215, y: 674, size: 10 });
            firstPage.drawText(name, { x: 215, y: 662, size: 10 });
            firstPage.drawText(fatherName, { x: 215, y: 650, size: 10 });
            firstPage.drawText(motherName, { x: 215, y: 637, size: 10 });
            firstPage.drawText(formattedBirthDate, { x: 215, y: 625, size: 10 });
            firstPage.drawText(nationality, { x: 215, y: 612, size: 10 });
            firstPage.drawText(serialNo, { x: 215, y: 599, size: 10 });
            firstPage.drawText(bloodType, { x: 215, y: 587, size: 10 });
            firstPage.drawText(email, { x: 215, y: 575, size: 10 });
            firstPage.drawText(phone, { x: 215, y: 562, size: 10 });
            firstPage.drawText(educationLevel, { x: 215, y: 550, size: 10 });
            firstPage.drawText(job, { x: 410, y: 551, size: 10 });
            firstPage.drawText(homeAddress, { x: 215, y: 537, size: 10 });
            firstPage.drawText(homePhone, { x: 215, y: 524, size: 10 });
            firstPage.drawText(workAddress, { x: 215, y: 512, size: 10 });
            firstPage.drawText(workPhone, { x: 215, y: 498, size: 10 });
            firstPage.drawText(emergencyName, { x: 215, y: 459, size: 10 });
            firstPage.drawText(emergencyRelation, { x: 215, y: 446, size: 10 });
            firstPage.drawText(emergencyAddress, { x: 215, y: 435, size: 10 });
            firstPage.drawText(emergencyPhone, { x: 215, y: 422, size: 10 });
            firstPage.drawText(day, { x: 348, y: 367, size: 10 });
            firstPage.drawText(month, { x: 365, y: 367, size: 10 });
            firstPage.drawText(year, { x: 399, y: 367, size: 10});
            firstPage.drawText(name, { x: 460, y: 360, size: 10 });

            const signatureImage = await pdfDoc.embedPng(signatureDataUrl);
            const signatureDims = signatureImage.scale(0.2);
            firstPage.drawImage(signatureImage, {
                x: 450,
                y: 300,
                width: signatureDims.width,
                height: signatureDims.height,
            });

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            let newWindow = null;

            // Browser check
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isMiBrowser = /MiuiBrowser/i.test(navigator.userAgent);

            if (isSafari || isMiBrowser) {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'document.pdf';
                link.click();
                alert('Tarayıcıda PDF açma desteği kısıtlı. Dosya indiriliyor.');
            } else {
                newWindow = window.open(url, '_blank');
                if (newWindow === null) {
                    alert("Pop-up engellendi. Lütfen tarayıcı ayarlarından pop-up izni verin.");
                } else {
                    newWindow.focus();
                }
            }

        });
    </script>
</body>
</html>
